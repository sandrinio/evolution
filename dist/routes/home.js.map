{"version":3,"sources":["../../routes/home.js"],"names":["express","require","router","Router","Posts","User","path","middleware","fs","formidable","readChunk","fileType","mailer","get","isLoggedIn","req","res","find","sort","exec","err","postContent","flash","render","page_name","reqsContent","findById","params","id","populate","result","post","photos","form","IncomingForm","multiples","uploadDir","join","__dirname","on","name","file","length","unlink","buffer","type","filename","sync","ext","Date","now","rename","push","status","publicPath","message","console","log","parse","fields","files","json","body","nPost","author","firstname","user","lastname","pic","_id","undefined","title","content","redirect","create","createdPost","postCount","Number","posts","finalCount","findByIdAndUpdate","delete","permissionChecker","findByIdAndRemove","blogPost","module","exports"],"mappings":"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","file":"home.js","sourcesContent":["var express = require('express');\nvar router = express.Router();\nvar Posts = require('../models/post');\nvar User = require('../models/user');\nvar path = require('path');\nvar middleware = require('../middleware');\nvar fs             = require('fs'),\n    formidable     = require('formidable'),\n    readChunk      = require('read-chunk'),\n    fileType       = require('file-type');\nvar mailer         = require('../middleware/mails')\n\n\n\n\nrouter.get('/home', middleware.isLoggedIn, function (req, res) {\n   Posts.find({'status': 'Solved'}).sort('-date').exec(function (err, postContent) {\n      if(err){\n         return req.flash('error', err)\n      }\n\n      res.render('main/home', {\n                           page_name: 'home',\n                           postContent: postContent })\n                     });\n});\n\nrouter.get('/instructions', middleware.isLoggedIn, function (req, res) {\n   Posts.find({'status': 'Instruction'}).sort('date').exec(function (err, postContent) {\n      if(err){\n         return req.flash('error', err)\n      }\n      res.render('requests/instructions', {\n         page_name: 'instructions',\n         reqsContent: postContent\n      })\n   })\n});\n\nrouter.get('/home/apple-reg', function (req, res) {\n   res.render('main/apple') \n});\n\nrouter.get('/home/google-reg', function (req, res) {\n   res.render('main/google') \n});\n\nrouter.get('/home/new-post', function (req, res) {\n   res.render('main/new', { page_name: 'none' });\n});\n\nrouter.get('/quiz', function (req, res) {\n   res.render('main/coming_soon');\n});\n\nrouter.get('/stock', function (req, res) {\n   res.render('main/coming_soon');\n});\n\nrouter.get('/target', function (req, res) {\n   res.render('main/coming_soon');\n});\n\nrouter.get('/home/show/:id', middleware.isLoggedIn, middleware.isLoggedIn, function (req, res) {\n   Posts.findById(req.params.id).populate(\"comments\").exec(function (err, result) {\n      if(err){\n         return req.flash(err)\n      }\n      res.render('main/show', {\n         page_name: 'none',\n         result: result\n      })\n   })\n});\n\n\nrouter.post('/upload_photos', function (req, res){\n   var photos = [],\n       form = new formidable.IncomingForm();\n\n   // Tells formidable that there will be multiple files sent.\n   form.multiples = true;\n   // Upload directory for the images\n   form.uploadDir = path.join(__dirname, '../public/uploads/blogUploads/');\n\n   // Invoked when a file has finished uploading.\n   form.on('file', function (name, file) {\n      // Allow only 3 files to be uploaded.\n      if (photos.length === 3) {\n         fs.unlink(file.path);\n         return true;\n      }\n\n      var buffer = null,\n          type = null,\n          filename = '';\n\n      // Read a chunk of the file.\n      buffer = readChunk.sync(file.path, 0, 262);\n      // Get the file type using the buffer read using read-chunk\n      type = fileType(buffer);\n\n      // Check the file type, must be either png,jpg or jpeg\n      if (type !== null && (type.ext === 'png' || type.ext === 'jpg' || type.ext === 'jpeg')) {\n            // Assign new file name\n         filename = Date.now() + '-' + file.name;\n\n         // Move the file with the new file name\n         fs.rename(file.path, path.join(__dirname, '../public/uploads/blogUploads/' + filename));\n\n         // Add to the list of photos\n         photos.push({\n            status: true,\n            filename: filename,\n            type: type.ext,\n            publicPath: '/uploads/blogUploads/' + filename\n         });\n      } else {\n         photos.push({\n            status: false,\n            filename: file.name,\n            message: 'Invalid file type'\n         });\n         fs.unlink(file.path);\n      }\n   });\n\n   form.on('error', function(err) {\n      console.log('Error occurred during processing - ' + err);\n   });\n\n   // Invoked when all the fields have been processed.\n   form.on('end', function() {\n      console.log('All the request fields have been processed.');\n   });\n\n   // Parse the incoming form fields.\n   form.parse(req, function (err, fields, files) {\n      res.status(200).json(photos);\n   });\n});\n\nrouter.post('/home/new-content', middleware.isLoggedIn, function (req, res) {\n   var postContent = req.body.nPost;\n   postContent.author = {\n      firstname: req.user.firstname,\n      lastname: req.user.lastname,\n      pic: req.user.pic,\n      id: req.user._id\n   };\n      if(req.body.status == undefined){\n      postContent.status = 'Unsolved'\n      } else {\n         postContent.status = req.body.status;\n      }\n\n   if(postContent.title.length <= 1 && postContent.content <= 1){\n      req.flash('error', 'სათაური ან კონტენტი თავისუფალია');\n      res.redirect('back')\n   }else{\n   Posts.create(postContent, function (err, createdPost) {\n      if(err){\n         return console.log(err);\n      }\n      var postCount = Number;\n      if(req.user.posts == undefined){\n         postCount = 1\n      }else{\n         postCount = req.user.posts + 1\n      }\n      var finalCount = { posts: postCount };\n\n      User.findByIdAndUpdate(req.user._id, finalCount, function (err, user) {\n         if(err){\n            return req.flash(\"error\", err)\n         }\n         req.flash(\"success\", \"Good Job :)\");\n         res.redirect(\"/home/show/\" + createdPost.id);\n      })\n\n   });\n   }\n});\nrouter.delete(\"/home/:id\", middleware.permissionChecker, function (req, res) {\n   Posts.findByIdAndRemove(req.params.id, function (err, blogPost) {\n      if(err){\n         console.log(err)\n      }else{\n         req.flash(\"success\", blogPost.title + \" \" + \"has been removed\");\n         res.redirect(\"back\");\n      }\n   });\n});\n\nmodule.exports = router;"]}