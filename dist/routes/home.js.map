{"version":3,"sources":["../../routes/home.js"],"names":["express","require","router","Router","Posts","User","path","middleware","mailer","multer","storage","diskStorage","destination","req","file","cb","filename","tempName","Date","now","originalname","imageName","imgName","upload","get","isLoggedIn","res","find","sort","exec","err","postContent","flash","render","page_name","reqsContent","findById","params","id","populate","result","post","any","html","query","CKEditorFuncNum","send","body","nPost","author","firstname","user","lastname","pic","_id","status","undefined","title","length","content","redirect","create","createdPost","console","log","postCount","Number","posts","finalCount","findByIdAndUpdate","delete","permissionChecker","findByIdAndRemove","blogPost","module","exports"],"mappings":"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","file":"home.js","sourcesContent":["var express = require('express');\nvar router = express.Router();\nvar Posts = require('../models/post');\nvar User = require('../models/user');\nvar path = require('path');\nvar middleware = require('../middleware');\nvar mailer         = require('../middleware/mails');\nlet multer = require('multer');\n\nconst storage = multer.diskStorage({\n   destination: function (req, file, cb) {\n      cb(null, 'public/uploads/blogUploads/')\n   },\n   filename: function (req, file, cb) {\n      let tempName = Date.now() + \"-\" + file.originalname;\n      cb(null, tempName);\n      imageName.imgName = tempName;\n   }\n});\nconst upload = multer({ storage: storage });\n\nlet imageName = {};\n\n\n\n\nrouter.get('/home', middleware.isLoggedIn, function (req, res) {\n   Posts.find({'status': 'Solved'}).sort('-date').exec(function (err, postContent) {\n      if(err){\n         return req.flash('error', err)\n      }\n      res.render('main/home', {\n         page_name: 'home',\n         postContent: postContent })\n                     });\n});\n\nrouter.get('/instructions', middleware.isLoggedIn, function (req, res) {\n   Posts.find({'status': 'Instruction'}).sort('date').exec(function (err, postContent) {\n      if(err){\n         return req.flash('error', err)\n      }\n      res.render('requests/instructions', {\n         page_name: 'instructions',\n         reqsContent: postContent\n      })\n   })\n});\n\nrouter.get('/home/apple-reg', function (req, res) {\n   res.render('main/apple') \n});\n\nrouter.get('/home/google-reg', function (req, res) {\n   res.render('main/google') \n});\n\nrouter.get('/home/new-post', function (req, res) {\n   res.render('main/new', { page_name: 'none' });\n});\n\nrouter.get('/quiz', function (req, res) {\n   res.render('main/coming_soon');\n});\n\nrouter.get('/stock', function (req, res) {\n   res.render('main/coming_soon');\n});\n\nrouter.get('/target', function (req, res) {\n   res.render('main/coming_soon');\n});\n\nrouter.get('/home/show/:id', middleware.isLoggedIn, middleware.isLoggedIn, function (req, res) {\n   Posts.findById(req.params.id).populate(\"comments\").exec(function (err, result) {\n      if(err){\n         return req.flash(err)\n      }\n      res.render('main/show', {\n         page_name: 'none',\n         result: result\n      })\n   })\n});\n\n\nrouter.post('/ck_upload', upload.any('editor1'), (req, res) => {\n\n   // console.log(imageName.imgName)\n\n   // res.send('/upload/basic_uploads/' + imageName.imgName)\n\n   html = \"\";\n   html += \"<script type='text/javascript'>\";\n   html += \"    var funcNum = \" + req.query.CKEditorFuncNum + \";\";\n   html += \"    var url     = \\\"/uploads/blogUploads/\" + imageName.imgName + \"\\\";\";\n   html += \"    var message = \\\"Uploaded file successfully\\\";\";\n   html += \"\";\n   html += \"    window.parent.CKEDITOR.tools.callFunction(funcNum, url, message);\";\n   html += \"</script>\";\n\n   res.send(html);\n});\n\nrouter.post('/home/new-content', middleware.isLoggedIn, function (req, res) {\n   var postContent = req.body.nPost;\n   postContent.author = {\n      firstname: req.user.firstname,\n      lastname: req.user.lastname,\n      pic: req.user.pic,\n      id: req.user._id\n   };\n      if(req.body.status == undefined){\n      postContent.status = 'Unsolved'\n      } else {\n         postContent.status = req.body.status;\n      }\n\n   if(postContent.title.length <= 1 && postContent.content <= 1){\n      req.flash('error', 'სათაური ან კონტენტი თავისუფალია');\n      res.redirect('back')\n   }else{\n   Posts.create(postContent, function (err, createdPost) {\n      if(err){\n         return console.log(err);\n      }\n      var postCount = Number;\n      if(req.user.posts == undefined){\n         postCount = 1\n      }else{\n         postCount = req.user.posts + 1\n      }\n      var finalCount = { posts: postCount };\n\n      User.findByIdAndUpdate(req.user._id, finalCount, function (err, user) {\n         if(err){\n            return req.flash(\"error\", err)\n         }\n         req.flash(\"success\", \"Good Job :)\");\n         res.redirect(\"/home/show/\" + createdPost.id);\n      })\n\n   });\n   }\n});\nrouter.delete(\"/home/:id\", middleware.permissionChecker, function (req, res) {\n   Posts.findByIdAndRemove(req.params.id, function (err, blogPost) {\n      if(err){\n         console.log(err)\n      }else{\n         req.flash(\"success\", blogPost.title + \" \" + \"has been removed\");\n         res.redirect(\"back\");\n      }\n   });\n});\n\nmodule.exports = router;"]}